<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Droid 用量查询</title>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --success-hover: #059669;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background-color: var(--bg-card);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(to bottom, #1e293b, #0f172a);
        }
        
        .github-link {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        
        .github-link:hover {
            color: var(--text-primary);
            opacity: 1;
            transform: scale(1.1);
        }
        
        .github-link svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        h1 {
            text-align: center;
            color: var(--text-primary);
            font-size: 1.875rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .main-content {
            padding: 2rem;
        }
        
        .card {
            background-color: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .input-group {
            display: flex;
            gap: 0.75rem;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background-color: var(--bg-body);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        input[type="text"]::placeholder {
            color: var(--text-secondary);
        }
        
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: var(--shadow-sm);
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.danger {
            background-color: var(--danger-color);
        }
        
        button.danger:hover {
            background-color: var(--danger-hover);
        }
        
        button.refresh {
            background-color: var(--success-color);
        }
        
        button.refresh:hover {
            background-color: var(--success-hover);
        }

        button.secondary {
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        
        button.secondary:hover {
            background-color: #475569; /* Slate-600 */
        }

        button.sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }
        
        .security-tip {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background-color: var(--bg-body);
        }
        
        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        th {
            background-color: rgba(30, 41, 59, 0.5);
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
            color: var(--text-primary);
        }
        
        .key-cell {
            font-family: 'Monaco', 'Consolas', monospace;
            color: var(--primary-color);
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background-color: var(--bg-input);
            border-radius: 9999px;
            margin-top: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        .progress-bar.low {
            background-color: var(--danger-color);
        }
        
        .progress-bar.medium {
            background-color: #f59e0b;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .message-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
        }

        .message-toast.show {
            transform: translateY(0);
        }
        
        .message-toast.error {
            background-color: var(--danger-color);
        }
        
        .message-toast.success {
            background-color: var(--success-color);
        }
        
        .actions {
            display: flex;
            gap: 0.5rem;
        }
        
        @media (max-width: 640px) {
            body { padding: 10px; }
            .header { padding: 1.5rem; }
            .main-content { padding: 1rem; }
            .card { padding: 1rem; }
            .input-group { flex-direction: column; }
            .header-actions { flex-direction: column; }
            button { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="https://github.com/qq33357486/droid-usage" target="_blank" class="github-link" title="GitHub">
                <svg viewBox="0 0 16 16" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            </a>
            <h1>Droid 用量查询</h1>
        </header>
        
        <div class="main-content">
            <div class="card add-key-section">
                <div class="card-header">
                    <h2>添加 API Key</h2>
                </div>
                <div class="input-group">
                    <input type="text" id="apiKeyInput" placeholder="输入 API Key (sk-...)">
                    <button onclick="addApiKey()">
                        <span>添加 Key</span>
                    </button>
                </div>
                <div class="security-tip">
                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    Key 仅存储在本地浏览器中，绝不上传到我们的服务器。
                </div>
            </div>
            
            <div class="card usage-section">
                <div class="card-header">
                    <h2>用量统计</h2>
                    <div class="header-actions">
                        <button class="refresh sm" onclick="refreshAllUsage()">刷新全部</button>
                        <button class="danger sm" onclick="cleanupLowBalance()">清理 < 5%</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="usageTable">
                        <thead>
                            <tr>
                                <th>API Key</th>
                                <th>初始额度</th>
                                <th>剩余额度</th>
                                <th style="width: 200px">余额</th>
                                <th>消耗速率</th>
                                <th>预计可用</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="usageTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="message-toast"></div>

    <script>
        // Store
        const store = {
            keys: [],
            load() {
                const data = localStorage.getItem('apiKeys');
                if (!data) return [];
                const parsed = JSON.parse(data);
                // Migration logic if needed
                if (parsed.length > 0 && typeof parsed[0] === 'string') {
                    return parsed.map(key => ({
                        key,
                        addedTime: Date.now(),
                        initialRemaining: null,
                        lastQueryTime: null,
                        lastRemaining: null,
                        consumeRate: 0
                    }));
                }
                return parsed;
            },
            save(keys) {
                localStorage.setItem('apiKeys', JSON.stringify(keys));
                this.keys = keys;
            },
            update(key, updates) {
                const keys = this.load();
                const index = keys.findIndex(k => k.key === key);
                if (index !== -1) {
                    keys[index] = { ...keys[index], ...updates };
                    this.save(keys);
                }
            }
        };

        // Utils
        const utils = {
            formatNumber: (num) => {
                if (num == null || num === '') return '0';
                const number = parseFloat(num);
                return isNaN(number) ? '0' : number.toLocaleString('zh-CN');
            },
            calculatePercentage: (initial, remaining) => {
                const initialNum = parseFloat(initial) || 0;
                const remainingNum = parseFloat(remaining) || 0;
                if (initialNum === 0) return 0;
                return (remainingNum / initialNum) * 100;
            },
            validateKey: (key) => {
                if (!key || key.length < 20) return 'API Key 长度不足';
                if (key.length > 200) return 'API Key 长度超出限制';
                if (!/^[a-zA-Z0-9_\-]+$/.test(key)) return 'API Key 包含非法字符';
                return null;
            }
        };

        // UI
        const ui = {
            showToast: (text, type = 'success') => {
                const toast = document.getElementById('toast');
                toast.textContent = text;
                toast.className = `message-toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },
            renderTable: () => {
                const tableBody = document.getElementById('usageTableBody');
                const keys = store.load();
                
                if (keys.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-secondary);">暂无 API Key，请在上方添加</td></tr>';
                    return;
                }
                
                // Keep existing rows if possible to avoid flicker
                // For simplicity in this version, we'll re-render but could be optimized
                if (tableBody.children.length === 0 || tableBody.children[0].cells.length === 1) {
                    tableBody.innerHTML = '';
                    keys.forEach(keyData => ui.createRow(keyData));
                }
            },
            createRow: (keyData) => {
                const tableBody = document.getElementById('usageTableBody');
                const row = document.createElement('tr');
                row.setAttribute('data-key', keyData.key);
                ui.updateRowContent(row, keyData);
                tableBody.appendChild(row);
            },
            updateRowContent: (row, keyData, usageData = null) => {
                const key = keyData.key;
                
                // Initial render with cached data or empty state
                let initial = 0, remaining = 0, percentage = 0, rate = keyData.consumeRate || 0;
                
                if (usageData) {
                    const std = usageData.usage.standard || {};
                    const prem = usageData.usage.premium || {};
                    const stdInit = std.totalAllowance || 0;
                    const premInit = prem.totalAllowance || 0;
                    const stdUsed = std.orgTotalTokensUsed || 0;
                    const premUsed = prem.orgTotalTokensUsed || 0;
                    
                    initial = stdInit + premInit;
                    remaining = (stdInit - stdUsed) + (premInit - premUsed);
                    percentage = utils.calculatePercentage(initial, remaining);
                } else if (keyData.lastRemaining !== null) {
                    // Use cached data if available
                    remaining = keyData.lastRemaining;
                    initial = keyData.initialRemaining || remaining; // Fallback
                    percentage = utils.calculatePercentage(initial, remaining);
                }

                // Rate calculation logic update
                const now = Date.now();
                if (usageData) {
                    // Always update initialRemaining with the true total allowance from API
                    // This fixes the bug where initialRemaining was set to 'remaining' erroneously
                    // and ensures we have the latest quota info
                    if (keyData.initialRemaining !== initial || keyData.lastRemaining !== remaining) {
                         const updates = {
                            initialRemaining: initial,
                            lastQueryTime: now,
                            lastRemaining: remaining
                        };
                        
                        // Only calculate rate if we have previous history
                        if (keyData.lastRemaining !== null && keyData.lastRemaining !== remaining) {
                            const consumed = keyData.lastRemaining - remaining;
                            const hoursDiff = (now - keyData.lastQueryTime) / 3600000;
                            if (hoursDiff > 0 && consumed > 0) {
                                updates.consumeRate = consumed / hoursDiff;
                            }
                        } else if (keyData.initialRemaining === null) {
                             // First time init, just set time
                             updates.lastQueryTime = now;
                        }
                        
                        store.update(key, updates);
                    }
                }

                // Progress bar color
                let progressClass = 'progress-bar';
                if (percentage < 20) progressClass += ' low';
                else if (percentage < 50) progressClass += ' medium';

                const rateDisplay = rate > 0 ? `${utils.formatNumber(Math.round(rate))}/h` : '-';
                
                let estimatedTime = '-';
                if (rate > 0) {
                    const totalHours = remaining / rate;
                    const h = Math.floor(totalHours);
                    const m = Math.floor((totalHours - h) * 60);
                    estimatedTime = `${h}h ${m}m`;
                }

                row.innerHTML = `
                    <td class="key-cell">${key.substring(0, 8)}...${key.substring(key.length - 4)}</td>
                    <td>${utils.formatNumber(initial)}</td>
                    <td>${utils.formatNumber(remaining)}</td>
                    <td>
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 2px;">
                            <span>${percentage.toFixed(1)}%</span>
                        </div>
                        <div class="progress-container">
                            <div class="${progressClass}" style="width: ${percentage}%"></div>
                        </div>
                    </td>
                    <td>${rateDisplay}</td>
                    <td>${estimatedTime}</td>
                    <td>
                        <div class="actions">
                            <button class="sm secondary" onclick="copyApiKey('${key}')">复制</button>
                            <button class="sm refresh" onclick="fetchUsage('${key}')">刷新</button>
                            <button class="sm danger" onclick="deleteApiKey('${key}')">删除</button>
                        </div>
                    </td>
                `;
            }
        };

        // Actions
        async function copyApiKey(key) {
            try {
                await navigator.clipboard.writeText(key);
                ui.showToast('API Key 已复制');
            } catch (err) {
                // Fallback for http or older browsers
                const textArea = document.createElement("textarea");
                textArea.value = key;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    ui.showToast('API Key 已复制');
                } catch (e) {
                    ui.showToast('复制失败', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        async function addApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            const error = utils.validateKey(key);
            
            if (error) {
                ui.showToast(error, 'error');
                return;
            }
            
            const keys = store.load();
            if (keys.some(k => k.key === key)) {
                ui.showToast('该 API Key 已存在', 'error');
                return;
            }
            
            keys.push({
                key,
                addedTime: Date.now(),
                initialRemaining: null,
                lastQueryTime: null,
                lastRemaining: null,
                consumeRate: 0
            });
            store.save(keys);
            input.value = '';
            ui.showToast('添加成功');
            
            // Add row immediately then fetch
            const newKeyData = keys[keys.length - 1];
            // If table was empty, clear it first
            const tableBody = document.getElementById('usageTableBody');
            if (tableBody.children.length === 1 && tableBody.children[0].cells.length === 1) {
                tableBody.innerHTML = '';
            }
            ui.createRow(newKeyData);
            fetchUsage(key);
        }

        function deleteApiKey(key) {
            if (!confirm('确定要删除这个 API Key 吗？')) return;
            const keys = store.load().filter(k => k.key !== key);
            store.save(keys);
            const row = document.querySelector(`tr[data-key="${key}"]`);
            if (row) row.remove();
            if (keys.length === 0) ui.renderTable();
            ui.showToast('删除成功');
        }

        async function fetchUsage(key) {
            const row = document.querySelector(`tr[data-key="${key}"]`);
            if (row) {
                const btn = row.querySelector('.refresh');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<span class="loading-spinner"></span>';
                }
            }

            try {
                const response = await fetch('/api/proxy', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                
                if (!response.ok) throw new Error(response.status);
                const data = await response.json();
                
                // Get fresh data from store in case it changed
                const keyData = store.load().find(k => k.key === key);
                if (keyData) {
                    ui.updateRowContent(row, keyData, data);
                }
            } catch (error) {
                console.error(error);
                ui.showToast('获取用量失败', 'error');
                if (row) {
                    // Reset button state
                    const btn = row.querySelector('.refresh');
                    if(btn) {
                        btn.disabled = false;
                        btn.textContent = '刷新';
                    }
                }
            }
        }

        async function refreshAllUsage() {
            const keys = store.load();
            if (keys.length === 0) {
                ui.showToast('列表为空', 'error');
                return;
            }
            
            ui.showToast('开始刷新全部...');
            for (const keyData of keys) {
                await fetchUsage(keyData.key);
            }
            ui.showToast('全部刷新完成');
        }

        function cleanupLowBalance() {
            const keys = store.load();
            const lowBalanceKeys = [];
            
            // Need to calculate percentage from stored data
            const rows = document.querySelectorAll('tr[data-key]');
            rows.forEach(row => {
                const text = row.cells[3].innerText; // Percentage cell
                const percent = parseFloat(text);
                if (!isNaN(percent) && percent < 5) {
                    lowBalanceKeys.push(row.getAttribute('data-key'));
                }
            });

            if (lowBalanceKeys.length === 0) {
                ui.showToast('没有发现余额低于 5% 的 Key');
                return;
            }

            if (!confirm(`发现 ${lowBalanceKeys.length} 个低余额 Key，确定删除？`)) return;

            const newKeys = keys.filter(k => !lowBalanceKeys.includes(k.key));
            store.save(newKeys);
            ui.renderTable();
            ui.showToast(`已清理 ${lowBalanceKeys.length} 个 Key`);
        }

        // Init
        window.onload = () => {
            ui.renderTable();
            const keys = store.load();
            if (keys.length > 0) {
                setTimeout(refreshAllUsage, 500);
            }
        };
    </script>
</body>
</html>
